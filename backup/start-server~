#!/usr/bin/env python
import sys
import argparse
import logging
import os
from subprocess import call

logging.basicConfig(level=logging.DEBUG,
                    stream=sys.stdout,
                    format="%(asctime)s [%(levelname)s] pid(%(process)d):thr(%(thread)d): %(message)s")

from AlmachBuildLibraryServer import app

parser = argparse.ArgumentParser("rampart-db-webui")
parser.add_argument('host', default='127.0.0.1')
parser.add_argument('-p', '--port', type=int, default=5001)
parser.add_argument('--use-debug-toolbar', action='store_true', default=False)
args = parser.parse_args()

app.config['DEBUG'] = True

if args.use_debug_toolbar:
    from flask_debugtoolbar import DebugToolbarExtension
    DebugToolbarExtension(app)

host=args.host
port=args.port

print "here1"
newpid = os.fork()
print "here2"
if newpid == 0:
    print "PID", newpid, os.getpid()
    client_enc ="4QTg4lAr7rQNI9xVGg8VP0Op1FCfWrWN4UbT0YtQMX4"
    access = "AKIAIRDGX7VOQRBRTXSA"
    secret = "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"
 
    call(['env', 'S3_CLIENT_ENCRYPT_SECRET=' + client_enc, 'S3_ACCESS_KEY='+access, 'S3_SECRET_KEY='+secret,'gunicorn', '--access-logfile', '-', '--debug', '-k', 'gevent', '-b', '0.0.0.0:5000', '-w', '1', 'docker_registry.wsgi:application'])
    ##call(['sudo', 'docker', 'start', 'sharp_bell'])
    os._exit(0)  
else:
    print "PID", newpid, os.getpid()
    app.run(debug=True, host=host, port=port, use_reloader=False)
